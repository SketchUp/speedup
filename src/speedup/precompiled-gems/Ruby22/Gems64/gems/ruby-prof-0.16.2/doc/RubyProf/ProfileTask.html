<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class RubyProf::ProfileTask - ruby-prof</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/darkfish.js"></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link">Rake::TestTask
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li class="calls-super" ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-i-clean_output_directory">#clean_output_directory</a>
    
    <li ><a href="#method-i-create_output_directory">#create_output_directory</a>
    
    <li ><a href="#method-i-define">#define</a>
    
    <li ><a href="#method-i-output_directory">#output_directory</a>
    
    <li ><a href="#method-i-run_script">#run_script</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-RubyProf::ProfileTask">
  <h1 id="class-RubyProf::ProfileTask" class="class">
    class RubyProf::ProfileTask
  </h1>

  <section class="description">
    
<p>Define a task library for profiling unit tests with ruby-prof.</p>

<p>All of the options provided by the Rake:TestTask are supported except the
loader which is set to ruby-prof.  For detailed information please refer to
the Rake:TestTask documentation.</p>

<p>ruby-prof specific options include:</p>

<pre>output_dir - For each file specified an output
             file with profile information will be
             written to the output directory.
             By default, the output directory is
             called &quot;profile&quot; and is created underneath
             the current working directory.

printer - Specifies the output printer.  Valid values include
          :flat, :graph, :graph_html and :call_tree.

min_percent - Methods that take less than the specified percent
              will not be written out.</pre>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;ruby-prof/task&#39;</span>

<span class="ruby-constant">RubyProf</span><span class="ruby-operator">::</span><span class="ruby-constant">ProfileTask</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">test_files</span> = <span class="ruby-constant">FileList</span>[<span class="ruby-string">&#39;test/test*.rb&#39;</span>]
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">output_dir</span> = <span class="ruby-string">&quot;c:/temp&quot;</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">printer</span> = :<span class="ruby-identifier">graph</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">min_percent</span> = <span class="ruby-value">10</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If rake is invoked with a “TEST=filename” command line option, then the
list of test files will be overridden to include only the filename
specified on the command line.  This provides an easy way to run just one
test.</p>

<p>If rake is invoked with a “TESTOPTS=options” command line option, then the
given options are passed to the test process after a &#39;–&#39;.  This
allows Test::Unit options to be passed to the test suite.</p>

<p>Examples:</p>

<pre class="ruby"><span class="ruby-identifier">rake</span> <span class="ruby-identifier">profile</span>                           <span class="ruby-comment"># run tests normally</span>
<span class="ruby-identifier">rake</span> <span class="ruby-identifier">profile</span> <span class="ruby-constant">TEST</span>=<span class="ruby-identifier">just_one_file</span>.<span class="ruby-identifier">rb</span>     <span class="ruby-comment"># run just one test file.</span>
<span class="ruby-identifier">rake</span> <span class="ruby-identifier">profile</span> <span class="ruby-constant">TESTOPTS</span>=<span class="ruby-string">&quot;-v&quot;</span>             <span class="ruby-comment"># run in verbose mode</span>
<span class="ruby-identifier">rake</span> <span class="ruby-identifier">profile</span> <span class="ruby-constant">TESTOPTS</span>=<span class="ruby-string">&quot;--runner=fox&quot;</span>   <span class="ruby-comment"># use the fox test runner</span>
</pre>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-min_percent" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">min_percent</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-output_dir" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">output_dir</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-printer" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">printer</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(name = :profile)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/ruby-prof/task.rb, line 64</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">name</span> = <span class="ruby-value">:profile</span>)
  <span class="ruby-keyword">super</span>(<span class="ruby-identifier">name</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-clean_output_directory" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clean_output_directory</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="clean_output_directory-source">
            <pre><span class="ruby-comment"># File lib/ruby-prof/task.rb, line 135</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clean_output_directory</span>
  <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">output_directory</span>)
    <span class="ruby-identifier">files</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">glob</span>(<span class="ruby-identifier">output_directory</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;/*&#39;</span>)
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm</span>(<span class="ruby-identifier">files</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-create_output_directory" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_output_directory</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="create_output_directory-source">
            <pre><span class="ruby-comment"># File lib/ruby-prof/task.rb, line 129</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">create_output_directory</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">output_directory</span>)
    <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">mkdir</span>(<span class="ruby-identifier">output_directory</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-define" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">define</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Create the tasks defined by this task lib.</p>
          
          

          
          <div class="method-source-code" id="define-source">
            <pre><span class="ruby-comment"># File lib/ruby-prof/task.rb, line 69</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">define</span>
  <span class="ruby-identifier">lib_path</span> = <span class="ruby-ivar">@libs</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-constant">PATH_SEPARATOR</span>)
  <span class="ruby-identifier">desc</span> <span class="ruby-string">&quot;Profile&quot;</span> <span class="ruby-operator">+</span> (<span class="ruby-ivar">@name</span><span class="ruby-operator">==</span><span class="ruby-value">:profile</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-node">&quot; for #{@name}&quot;</span>)

  <span class="ruby-identifier">task</span> <span class="ruby-ivar">@name</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">create_output_directory</span>

    <span class="ruby-ivar">@ruby_opts</span>.<span class="ruby-identifier">unshift</span>( <span class="ruby-node">&quot;-I#{lib_path}&quot;</span> )
    <span class="ruby-ivar">@ruby_opts</span>.<span class="ruby-identifier">unshift</span>( <span class="ruby-string">&quot;-w&quot;</span> ) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@warning</span>
    <span class="ruby-ivar">@ruby_opts</span>.<span class="ruby-identifier">push</span>(<span class="ruby-string">&quot;-S ruby-prof&quot;</span>)
    <span class="ruby-ivar">@ruby_opts</span>.<span class="ruby-identifier">push</span>(<span class="ruby-node">&quot;--printer #{@printer}&quot;</span>)
    <span class="ruby-ivar">@ruby_opts</span>.<span class="ruby-identifier">push</span>(<span class="ruby-node">&quot;--min_percent #{@min_percent}&quot;</span>)

    <span class="ruby-identifier">file_list</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file_path</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">run_script</span>(<span class="ruby-identifier">file_path</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-output_directory" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">output_directory</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="output_directory-source">
            <pre><span class="ruby-comment"># File lib/ruby-prof/task.rb, line 125</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">output_directory</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-ivar">@output_dir</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-run_script" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">run_script</span><span
            class="method-args">(script_path)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Run script</p>
          
          

          
          <div class="method-source-code" id="run_script-source">
            <pre><span class="ruby-comment"># File lib/ruby-prof/task.rb, line 90</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">run_script</span>(<span class="ruby-identifier">script_path</span>)
  <span class="ruby-identifier">run_code</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-constant">RakeFileUtils</span>.<span class="ruby-identifier">verbose</span>(<span class="ruby-ivar">@verbose</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">file_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">script_path</span>, <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">script_path</span>))
    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@printer</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:flat</span>, <span class="ruby-value">:graph</span>, <span class="ruby-value">:call_tree</span>
        <span class="ruby-identifier">file_name</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;.txt&quot;</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:graph_html</span>
        <span class="ruby-identifier">file_name</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;.html&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">file_name</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;.txt&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">output_file_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">output_directory</span>, <span class="ruby-identifier">file_name</span>)

    <span class="ruby-identifier">command_line</span> = <span class="ruby-ivar">@ruby_opts</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot; &quot;</span>) <span class="ruby-operator">+</span>
                  <span class="ruby-string">&quot; --file=&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">output_file_path</span> <span class="ruby-operator">+</span>
                  <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">script_path</span>

    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;ruby &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">command_line</span>
    <span class="ruby-comment"># We have to catch the exeption to continue on.  However,</span>
    <span class="ruby-comment"># the error message will have been output to STDERR</span>
    <span class="ruby-comment"># already by the time we get here so we don&#39;t have to</span>
    <span class="ruby-comment"># do that again</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">ruby</span> <span class="ruby-identifier">command_line</span>
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-constant">STDOUT</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">e</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n&quot;</span>
      <span class="ruby-constant">STDOUT</span>.<span class="ruby-identifier">flush</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;&quot;</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

